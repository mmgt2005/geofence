<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geofence App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { width: 100%; height: 100%; }
        .mapboxgl-ctrl-directions {
            top: 1rem; left: 1rem; right: auto;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .mapbox-directions-step-active {
            background-color:#007cbf!important; color:white!important; font-weight:800;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="map" class="flex-1"></div>
    <div class="p-4 bg-gray-900 text-white shadow-lg z-10 flex flex-col sm:flex-row items-center justify-between rounded-t-xl">
        <div>
            <p id="message" class="text-xl font-bold mb-1">Please grant location permission to start...</p>
            <p id="job-message" class="text-xs text-gray-400 hidden"></p>
        </div>
        <div class="flex items-center space-x-2">
            <button id="arrived-button" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition-colors hidden">Job Complete</button>
            <button id="voice-button" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors">üó£Ô∏è</button>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibW1ndDIwMDUiLCJhIjoiY21laW4xY2dqMDQ1NDJpcHdqOW1hMDk3ZCJ9.aSTR_k5xhzGJNPPAVAFnlw';
        const WEBHOOK_URL = 'https://go.glideapps.com/api/container/plugin/webhook-trigger/LPCunXsYkOiRLSxXBhSH/5322e093-74bf-4793-92fa-ef5713bf8ab1';

        let map, vehicleMarker, geofence, directions;
        let isInsideGeofence = false, jobTitle, geofenceLocation;
        let isInitialLoad = true, lastInstruction = '', speechActive = false;

        function initVoices() {
            let voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
            }
        }
        initVoices();

        function getUrlParams() {
            const params = {};
            new URLSearchParams(window.location.search).forEach((value, key) => {
                params[key] = (key === 'lat' || key === 'lon' || key === 'radius') ? parseFloat(value) : value;
            });
            return params;
        }

        async function sendWebhook(status,email,latitude,longitude){
            if(!WEBHOOK_URL){console.warn("Webhook URL not configured.");return;}
            try{
                const data={status,latitude,longitude,email,job:jobTitle,timestamp:new Date().toISOString()};
                const r=await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
                if(!r.ok)console.error('Webhook failed',r.status);
            }catch(e){console.error('Error sending webhook:',e);}
        }

        function checkGeofence(email,latitude,longitude){
            if(!geofence||!vehicleMarker)return;
            const msg=document.getElementById('message');
            const jobMsg=document.getElementById('job-message');
            const point=turf.point([longitude,latitude]);
            const inside=turf.booleanPointInPolygon(point,geofence);
            if(jobTitle&&jobTitle!=='a job'){jobMsg.textContent=`Job: ${jobTitle}`;jobMsg.classList.remove('hidden');}
            else{jobMsg.classList.add('hidden');}

            if(inside&&!isInsideGeofence){sendWebhook('inside',email,latitude,longitude);isInsideGeofence=true;msg.textContent='Vehicle is at the job location!';}
            else if(!inside&&isInsideGeofence){sendWebhook('outside',email,latitude,longitude);isInsideGeofence=false;msg.textContent='Vehicle has left the job location!';}
            else if(!isInsideGeofence){msg.textContent='Vehicle is on its way to the job location...';}
        }

        function speakText(text){
            if(!text) return;
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang='en-US';
            utter.rate=1;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }

        function speakInstructions(){
            if(!speechActive) return;
            const el = document.querySelector('.mapbox-directions-step-active .mapbox-directions-step-maneuver-instruction');
            if(el){
                const text = el.textContent.trim();
                if(text && text !== lastInstruction){
                    document.getElementById('message').textContent = text;
                    speakText(text);
                    lastInstruction = text;
                }
            }
        }
        
        // This new function handles getting and speaking the very first instruction.
        function speakFirstInstruction() {
            if (speechActive) {
                setTimeout(() => {
                    const firstEl = document.querySelector('.mapbox-directions-step-maneuver-instruction');
                    if (firstEl) {
                        const text = firstEl.textContent.trim();
                        if (text) {
                            document.getElementById('message').textContent = text;
                            speakText(text);
                            lastInstruction = text;
                        }
                    }
                }, 500); // allow DOM update
            }
        }

        function onGeolocationSuccess(pos){
            const coords=pos.coords;
            const userLoc=new mapboxgl.LngLat(coords.longitude,coords.latitude);
            const userEmail=getUrlParams().email||'testuser@example.com';

            if(!vehicleMarker){
                const car=document.createElement('div');car.innerHTML='üöó';car.style.fontSize='32px';
                vehicleMarker=new mapboxgl.Marker({element:car}).setLngLat(userLoc).addTo(map);
                document.getElementById('arrived-button').classList.remove('hidden');

                directions=new MapboxDirections({accessToken:mapboxgl.accessToken,unit:'imperial',profile:'mapbox/driving',controls:{inputs:false,instructions:true,profileSwitcher:true}});
                map.addControl(directions,'top-left');
                map.dragPan.disable();
                map.on('mousedown',()=>{document.getElementById('message').textContent="Map movement is disabled for this navigation.";});
                if(geofenceLocation) directions.setDestination([geofenceLocation.lng,geofenceLocation.lat]);

                directions.on('route',()=>{
                    const voiceButton = document.getElementById('voice-button');
                    // Add a visual indicator that voice navigation is available
                    voiceButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    voiceButton.classList.add('bg-green-500', 'hover:bg-green-600', 'ring-4', 'ring-green-400');
                    // The "Voice navigation is now ready!" message has been removed as requested.

                    // Now call the new function to speak the first instruction
                    speakFirstInstruction();
                });

                const panel=document.querySelector('.mapboxgl-ctrl-directions-instructions');
                if(panel){
                    const obs=new MutationObserver(muts=>{
                        for(const m of muts){
                            if(m.type==='attributes' && m.attributeName==='class' && m.target.classList && m.target.classList.contains('mapbox-directions-step-active')){
                                speakInstructions();
                            }
                        }
                    });
                    obs.observe(panel,{subtree:true,attributes:true,attributeFilter:['class'],childList:true});
                }
            }
            vehicleMarker.setLngLat(userLoc);
            if(isInitialLoad){ map.setCenter(userLoc); isInitialLoad=false; }
            directions.setOrigin([coords.longitude,coords.latitude]);
            checkGeofence(userEmail,coords.latitude,coords.longitude);
        }

        function onGeolocationError(err){
            document.getElementById('message').textContent=`Geolocation error: ${err.message}`;
            console.warn(`Geolocation error(${err.code}): ${err.message}`);
        }

        window.onload=function(){
            const {lat,lon,radius,job}=getUrlParams();
            jobTitle=job||'Sample Job Title';
            const geofenceLat=lat||40.7128, geofenceLon=lon||-74.0060, geofenceRadius=radius||500;
            geofenceLocation={lat:geofenceLat,lng:geofenceLon};
            const jobMsg=document.getElementById('job-message');
            if(jobTitle&&jobTitle!=='a job'){ jobMsg.textContent=`Job: ${jobTitle}`; jobMsg.classList.remove('hidden'); }

            map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/streets-v12',center:[geofenceLon,geofenceLat],zoom:12});

            map.on('load',()=>{
                const center=[geofenceLon,geofenceLat];
                geofence=turf.circle(center,geofenceRadius,{steps:64,units:'feet'});
                map.addSource('geofence',{type:'geojson',data:geofence});
                map.addLayer({id:'geofence-layer',type:'fill',source:'geofence',paint:{'fill-color':'#007cbf','fill-opacity':0.3}});
                new mapboxgl.Marker({color:'#007cbf'}).setLngLat(center).addTo(map);
                if(navigator.geolocation){ navigator.geolocation.watchPosition(onGeolocationSuccess,onGeolocationError,{enableHighAccuracy:true,timeout:5000,maximumAge:0}); }
                else{ document.getElementById('message').textContent='Geolocation not supported.'; }
            });

            document.getElementById('arrived-button').addEventListener('click',()=>{
                const userEmail=getUrlParams().email||'testuser@example.com';
                const loc=vehicleMarker.getLngLat();
                sendWebhook('complete',userEmail,loc.lat,loc.lng);
                document.getElementById('message').textContent='Job Complete!';
                setTimeout(()=>{ window.close(); },1000);
            });

            document.getElementById('voice-button').addEventListener('click',()=>{
                speechActive=!speechActive;
                const msg=document.getElementById('message');
                const btn=document.getElementById('voice-button');
                window.speechSynthesis.cancel();
                if(speechActive){
                    // Only say "Voice navigation enabled" once at the beginning
                    const prime=new SpeechSynthesisUtterance("Voice navigation enabled.");
                    prime.lang='en-US';
                    window.speechSynthesis.speak(prime);
                    msg.textContent='Voice navigation enabled.';
                    btn.textContent='üîá';
                    
                    // Call the new function to speak the first instruction when voice is enabled
                    speakFirstInstruction();
                }else{
                    msg.textContent='Voice navigation disabled.';
                    btn.textContent='üó£Ô∏è';
                }
            });
        }
    </script>
</body>
</html>
